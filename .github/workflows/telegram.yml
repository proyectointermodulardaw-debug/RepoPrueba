name: Notify Telegram

on:
  push:            # <- sin 'branches', asÃ­ pilla TODAS las ramas y tambiÃ©n tags
  pull_request:    # PR en cualquier rama
    types: [opened, closed, reopened, synchronize]
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Notify (push)
        if: github.event_name == 'push'
        run: |
          # Para push a branch o a tag
          REF_NAME="${GITHUB_REF_NAME}"   # rama o tag
          ACTOR="${GITHUB_ACTOR}"
          REPO="${GITHUB_REPOSITORY}"

          # Lista de commits (si los hay; en push de tag puede venir vacÃ­o)
          if jq -e '.commits | length > 0' "$GITHUB_EVENT_PATH" > /dev/null; then
            COMMITS=$(jq -r '.commits[] | "- \(.message) [\(.id[0:7])] by \(.author.username // .author.name)"' "$GITHUB_EVENT_PATH")
          else
            COMMITS="(sin lista de commits â€” puede ser un tag o fast-forward)"
          fi

          COMMITS_ENC=$(printf "%s" "$COMMITS" | jq -s -R -r @uri)
          TEXT="ðŸ“¦ Repo: ${REPO}%0AðŸ”€ Ref: ${REF_NAME}%0AðŸ‘¤ Actor: ${ACTOR}%0AðŸ“ Commits:%0A${COMMITS_ENC}"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_TOPIC_ID }}" \
            -d text="$TEXT" \
            -d disable_web_page_preview=true > /dev/null

      - name: Notify (pull_request)
        if: github.event_name == 'pull_request'
        run: |
          ACTION="${{ github.event.action }}"
          NUMBER="${{ github.event.number }}"
          TITLE=$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")
          URL=$(jq -r '.pull_request.html_url' "$GITHUB_EVENT_PATH")
          MERGED=$(jq -r '.pull_request.merged // false' "$GITHUB_EVENT_PATH")
          if [ "$ACTION" = "closed" ] && [ "$MERGED" = "true" ]; then
            ACTION="merged"
          fi

          TEXT=$(printf "ðŸ”” PR %s: #%s\nðŸ§© %s\nðŸ”— %s\nðŸ‘¤ %s" "$ACTION" "$NUMBER" "$TITLE" "$URL" "${GITHUB_ACTOR}" | jq -s -R -r @uri)

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_TOPIC_ID }}" \
            -d text="$TEXT" \
            -d disable_web_page_preview=true > /dev/null

      - name: Notify (release)
        if: github.event_name == 'release'
        run: |
          NAME="${{ github.event.release.name }}"
          TAG="${{ github.event.release.tag_name }}"
          URL="${{ github.event.release.html_url }}"
          TEXT=$(printf "ðŸš€ Release publicada:\nðŸ·ï¸ %s (%s)\nðŸ”— %s\nðŸ‘¤ %s" "$NAME" "$TAG" "$URL" "${GITHUB_ACTOR}" | jq -s -R -r @uri)

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_TOPIC_ID }}" \
            -d text="$TEXT" \
            -d disable_web_page_preview=true > /dev/null
